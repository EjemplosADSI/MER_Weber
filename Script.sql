-- MySQL Script generated by MySQL Workbench
-- Wed Jul 23 17:50:41 2025
-- Model: New Model    Version: 1.0
-- MySQL Workbench Forward Engineering

SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0;
SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0;
SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION';

-- -----------------------------------------------------
-- Schema weber
-- -----------------------------------------------------

-- -----------------------------------------------------
-- Schema weber
-- -----------------------------------------------------
CREATE SCHEMA IF NOT EXISTS `weber` DEFAULT CHARACTER SET utf8mb3 ;
USE `weber` ;

-- -----------------------------------------------------
-- Table `weber`.`archivos`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `weber`.`archivos` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `model` VARCHAR(60) NOT NULL COMMENT 'Nombre del modelo (productos, usuarios, etc.)',
  `model_id` BIGINT UNSIGNED NOT NULL COMMENT 'ID del registro relacionado',
  `uuid` CHAR(36) NOT NULL COMMENT 'UUID único para el archivo',
  `nombre_original` VARCHAR(255) NOT NULL COMMENT 'Nombre original del archivo',
  `ruta_archivo` VARCHAR(500) NOT NULL COMMENT 'Ruta completa en el storage',
  `tipo_archivo` ENUM('imagen', 'documento', 'video', 'audio', 'archivo', 'otro') NOT NULL,
  `etiquetas` JSON NULL DEFAULT NULL COMMENT 'Tags adicionales para búsqueda',
  `estado` ENUM('activo', 'archivado', 'eliminado') NULL DEFAULT 'activo',
  PRIMARY KEY (`id`),
  UNIQUE INDEX `uuid_unique` (`uuid` ASC) VISIBLE,
  INDEX `model_idx` (`model` ASC, `model_id` ASC) VISIBLE,
  INDEX `tipo_archivo_idx` (`tipo_archivo` ASC) VISIBLE,
  INDEX `estado_idx` (`estado` ASC) VISIBLE,
  INDEX `ruta_archivo_idx` (`ruta_archivo`(100) ASC) VISIBLE)
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `weber`.`categorias`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `weber`.`categorias` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `nombre` VARCHAR(80) NOT NULL,
  `descripcion` TEXT NULL DEFAULT NULL,
  `categoria_padre_id` BIGINT UNSIGNED NULL DEFAULT NULL COMMENT 'Para categorías jerárquicas',
  `estado` ENUM('Activo', 'Inactivo') NOT NULL DEFAULT 'Activo',
  PRIMARY KEY (`id`),
  INDEX `fk_categorias_padre_idx` (`categoria_padre_id` ASC) VISIBLE,
  CONSTRAINT `fk_categorias_padre`
    FOREIGN KEY (`categoria_padre_id`)
    REFERENCES `weber`.`categorias` (`id`)
    ON DELETE SET NULL
    ON UPDATE CASCADE)
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `weber`.`departamentos`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `weber`.`departamentos` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `nombre` VARCHAR(90) NOT NULL,
  `region` ENUM('Caribe', 'Centro Oriente', 'Centro Sur', 'Eje Cafetero - Antioquia', 'Llano', 'Pacífico') NOT NULL,
  `estado` ENUM('Activo', 'Inactivo') NOT NULL DEFAULT 'Activo',
  PRIMARY KEY (`id`),
  UNIQUE INDEX `departamentos_nombre_unique` (`nombre` ASC) VISIBLE)
ENGINE = InnoDB
AUTO_INCREMENT = 100
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `weber`.`municipios`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `weber`.`municipios` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `nombre` VARCHAR(90) NOT NULL,
  `departamento_id` BIGINT UNSIGNED NOT NULL,
  `abreviatura` VARCHAR(40) NULL DEFAULT NULL,
  `estado` ENUM('Activo', 'Inactivo') NOT NULL DEFAULT 'Activo',
  PRIMARY KEY (`id`),
  INDEX `municipios_nombre_index` (`nombre` ASC) VISIBLE,
  INDEX `municipios_departamento_id_index` (`departamento_id` ASC) VISIBLE,
  CONSTRAINT `municipios_departamento_id_foreign`
    FOREIGN KEY (`departamento_id`)
    REFERENCES `weber`.`departamentos` (`id`)
    ON UPDATE CASCADE)
ENGINE = InnoDB
AUTO_INCREMENT = 99774
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `weber`.`empresas`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `weber`.`empresas` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `nombre` VARCHAR(80) NOT NULL,
  `nit` VARCHAR(20) NOT NULL COMMENT 'Número de Identificación Tributaria',
  `estado` ENUM('Activo', 'Inactivo') NOT NULL DEFAULT 'Activo',
  PRIMARY KEY (`id`),
  UNIQUE INDEX `nit_UNIQUE` (`nit` ASC) VISIBLE)
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `weber`.`sucursales`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `weber`.`sucursales` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `empresa_id` BIGINT UNSIGNED NOT NULL,
  `nombre` VARCHAR(80) NOT NULL,
  `administrador_id` BIGINT UNSIGNED NULL DEFAULT NULL COMMENT 'Referencia a perfiles_usuario - NULLABLE para evitar referencia circular',
  `direccion` VARCHAR(200) NOT NULL,
  `municipio_id` BIGINT UNSIGNED NOT NULL,
  `telefono` VARCHAR(20) NOT NULL,
  `tipo` ENUM('Principal', 'Subsede') NOT NULL DEFAULT 'Principal',
  `estado` ENUM('Activo', 'Inactivo') NOT NULL DEFAULT 'Activo',
  PRIMARY KEY (`id`),
  INDEX `fk_sucursales_administrador_idx` (`administrador_id` ASC) VISIBLE,
  INDEX `fk_sucursales_municipios_idx` (`municipio_id` ASC) VISIBLE,
  INDEX `fk_sucursales_empresas_idx` (`empresa_id` ASC) VISIBLE,
  CONSTRAINT `fk_sucursales_administrador`
    FOREIGN KEY (`administrador_id`)
    REFERENCES `weber`.`perfiles_usuario` (`id`)
    ON DELETE SET NULL
    ON UPDATE CASCADE,
  CONSTRAINT `fk_sucursales_empresas`
    FOREIGN KEY (`empresa_id`)
    REFERENCES `weber`.`empresas` (`id`)
    ON DELETE RESTRICT
    ON UPDATE CASCADE,
  CONSTRAINT `fk_sucursales_municipios`
    FOREIGN KEY (`municipio_id`)
    REFERENCES `weber`.`municipios` (`id`)
    ON DELETE RESTRICT
    ON UPDATE CASCADE)
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `weber`.`perfiles_usuario`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `weber`.`perfiles_usuario` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `usuario_id` BIGINT UNSIGNED NOT NULL COMMENT 'ID del usuario en la tabla del framework (users de Laravel/Django)',
  `codigo_empleado` VARCHAR(20) NULL DEFAULT NULL COMMENT 'Código de empleado interno',
  `tipo_documento` ENUM('C.C', 'C.E', 'T.I', 'R.C', 'Pasaporte') NOT NULL,
  `documento` VARCHAR(20) NOT NULL COMMENT 'Número de documento de identidad',
  `telefono` VARCHAR(20) NULL DEFAULT NULL COMMENT 'Teléfono de contacto',
  `direccion` VARCHAR(200) NULL DEFAULT NULL,
  `municipio_id` BIGINT UNSIGNED NULL DEFAULT NULL,
  `fecha_nacimiento` DATE NULL DEFAULT NULL,
  `rol_negocio` ENUM('Administrador', 'Empleado', 'Cliente', 'Proveedor') NOT NULL,
  `estado` ENUM('Activo', 'Inactivo', 'Suspendido') NOT NULL DEFAULT 'Activo',
  `fecha_contratacion` DATE NULL DEFAULT NULL COMMENT 'Fecha de contratación para empleados',
  `fecha_terminacion` DATE NULL DEFAULT NULL COMMENT 'Fecha de terminación',
  `sucursal_id` BIGINT UNSIGNED NULL DEFAULT NULL COMMENT 'Sucursal a la que pertenece el empleado',
  PRIMARY KEY (`id`),
  UNIQUE INDEX `documento_unique` (`documento` ASC) VISIBLE,
  UNIQUE INDEX `usuario_framework_unique` (`usuario_id` ASC) VISIBLE,
  INDEX `fk_perfiles_usuario_municipios_idx` (`municipio_id` ASC) VISIBLE,
  INDEX `rol_negocio_idx` (`rol_negocio` ASC) VISIBLE,
  INDEX `fk_perfiles_usuario_sucursal_idx` (`sucursal_id` ASC) VISIBLE,
  CONSTRAINT `fk_perfiles_usuario_municipios`
    FOREIGN KEY (`municipio_id`)
    REFERENCES `weber`.`municipios` (`id`)
    ON DELETE SET NULL
    ON UPDATE CASCADE,
  CONSTRAINT `fk_perfiles_usuario_sucursal`
    FOREIGN KEY (`sucursal_id`)
    REFERENCES `weber`.`sucursales` (`id`)
    ON DELETE SET NULL
    ON UPDATE CASCADE)
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `weber`.`transacciones`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `weber`.`transacciones` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `numero` VARCHAR(50) NOT NULL,
  `perfil_usuario_id` BIGINT UNSIGNED NOT NULL COMMENT 'Cliente/Proveedor desde perfiles_usuario',
  `perfil_empleado_id` BIGINT UNSIGNED NOT NULL COMMENT 'Empleado desde perfiles_usuario',
  `fecha` DATETIME NOT NULL,
  `monto` DECIMAL(15,2) NOT NULL,
  `estado` ENUM('En progreso', 'Cancelada', 'Finalizada') NOT NULL DEFAULT 'En progreso',
  `observaciones` TEXT NULL DEFAULT NULL COMMENT 'Notas adicionales',
  PRIMARY KEY (`id`),
  UNIQUE INDEX `numero_unique` (`numero` ASC) VISIBLE,
  INDEX `fk_transacciones_perfil_usuario_idx` (`perfil_usuario_id` ASC) VISIBLE,
  INDEX `fk_transacciones_perfil_empleado_idx` (`perfil_empleado_id` ASC) VISIBLE,
  INDEX `fecha_idx` (`fecha` ASC) VISIBLE,
  INDEX `estado_idx` (`estado` ASC) VISIBLE,
  CONSTRAINT `fk_transacciones_perfil_empleado`
    FOREIGN KEY (`perfil_empleado_id`)
    REFERENCES `weber`.`perfiles_usuario` (`id`)
    ON DELETE RESTRICT
    ON UPDATE CASCADE,
  CONSTRAINT `fk_transacciones_perfil_usuario`
    FOREIGN KEY (`perfil_usuario_id`)
    REFERENCES `weber`.`perfiles_usuario` (`id`)
    ON DELETE RESTRICT
    ON UPDATE CASCADE)
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `weber`.`compras`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `weber`.`compras` (
  `id` BIGINT UNSIGNED NOT NULL,
  `perfil_proveedor_id` BIGINT UNSIGNED NOT NULL COMMENT 'Referencia específica al proveedor',
  `fecha_entrega` DATE NULL DEFAULT NULL,
  `numero_factura_proveedor` VARCHAR(100) NULL DEFAULT NULL COMMENT 'Número de factura del proveedor',
  `terminos_pago` VARCHAR(100) NULL DEFAULT NULL COMMENT 'Términos de pago',
  `direccion_entrega` VARCHAR(200) NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  INDEX `fk_compras_perfil_proveedor_idx` (`perfil_proveedor_id` ASC) VISIBLE,
  CONSTRAINT `fk_compras_perfil_proveedor`
    FOREIGN KEY (`perfil_proveedor_id`)
    REFERENCES `weber`.`perfiles_usuario` (`id`)
    ON DELETE RESTRICT
    ON UPDATE CASCADE,
  CONSTRAINT `fk_compras_transacciones`
    FOREIGN KEY (`id`)
    REFERENCES `weber`.`transacciones` (`id`)
    ON DELETE CASCADE
    ON UPDATE CASCADE)
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `weber`.`productos`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `weber`.`productos` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `codigo` VARCHAR(50) NULL DEFAULT NULL COMMENT 'Código único del producto (SKU)',
  `nombre` VARCHAR(100) NOT NULL,
  `descripcion` TEXT NULL DEFAULT NULL,
  `stock` INT UNSIGNED NOT NULL DEFAULT '0',
  `stock_minimo` INT UNSIGNED NULL DEFAULT '0' COMMENT 'Stock mínimo para alertas',
  `stock_maximo` INT UNSIGNED NULL DEFAULT NULL COMMENT 'Stock máximo',
  `unidad` VARCHAR(20) NULL DEFAULT 'Unidad' COMMENT 'Unidad de medida',
  `ganancia_sugerida` DECIMAL(5,2) NULL DEFAULT '50.00' COMMENT 'Porcentaje de ganancia sugerida (puede cambiar)',
  `estado` ENUM('Activo', 'Inactivo', 'Descontinuado') NOT NULL DEFAULT 'Activo',
  PRIMARY KEY (`id`),
  UNIQUE INDEX `codigo_unique` (`codigo` ASC) VISIBLE,
  INDEX `nombre_idx` (`nombre` ASC) VISIBLE,
  INDEX `estado_idx` (`estado` ASC) VISIBLE)
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `weber`.`detalles_compras`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `weber`.`detalles_compras` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `compra_id` BIGINT UNSIGNED NOT NULL,
  `producto_id` BIGINT UNSIGNED NOT NULL,
  `lote` VARCHAR(50) NULL DEFAULT NULL COMMENT 'Número de lote (opcional)',
  `fecha_vencimiento` DATE NULL DEFAULT NULL,
  `cantidad` DECIMAL(10,2) NOT NULL,
  `costo_unitario` DECIMAL(15,2) NOT NULL,
  `subtotal` DECIMAL(15,2) NOT NULL,
  `monto_impuesto` DECIMAL(15,2) NULL DEFAULT '0.00',
  `cantidad_disponible` DECIMAL(10,2) NOT NULL COMMENT 'Cantidad disponible para venta (se reduce con cada venta)',
  `porcentaje_ganancia_aplicado` DECIMAL(5,2) NOT NULL COMMENT 'Porcentaje de ganancia aplicado a este lote',
  `precio_venta_calculado` DECIMAL(15,2) NOT NULL COMMENT 'Precio de venta calculado con la ganancia',
  `esta_agotado` TINYINT(1) NULL DEFAULT '0' COMMENT 'TRUE cuando cantidad_disponible = 0',
  PRIMARY KEY (`id`),
  INDEX `fk_detalles_compras_compras_idx` (`compra_id` ASC) VISIBLE,
  INDEX `fk_detalles_compras_productos_idx` (`producto_id` ASC) VISIBLE,
  INDEX `lote_idx` (`lote` ASC) VISIBLE,
  INDEX `fecha_vencimiento_idx` (`fecha_vencimiento` ASC) VISIBLE,
  INDEX `cantidad_disponible_idx` (`cantidad_disponible` ASC) VISIBLE,
  INDEX `esta_agotado_idx` (`esta_agotado` ASC) VISIBLE,
  INDEX `fifo_orden_idx` (`producto_id` ASC) COMMENT '\'Índice para ordenamiento FIFO\'' VISIBLE,
  CONSTRAINT `fk_detalles_compras_compras`
    FOREIGN KEY (`compra_id`)
    REFERENCES `weber`.`compras` (`id`)
    ON DELETE CASCADE
    ON UPDATE CASCADE,
  CONSTRAINT `fk_detalles_compras_productos`
    FOREIGN KEY (`producto_id`)
    REFERENCES `weber`.`productos` (`id`)
    ON DELETE RESTRICT
    ON UPDATE CASCADE)
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `weber`.`ventas`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `weber`.`ventas` (
  `id` BIGINT UNSIGNED NOT NULL,
  `perfil_cliente_id` BIGINT UNSIGNED NOT NULL COMMENT 'Referencia específica al cliente',
  `metodo_pago` ENUM('Efectivo', 'Tarjeta', 'Transferencia', 'Crédito') NULL DEFAULT 'Efectivo',
  `porcentaje_descuento` DECIMAL(5,2) NULL DEFAULT '0.00',
  `porcentaje_impuesto` DECIMAL(5,2) NULL DEFAULT '0.00',
  `numero_factura` VARCHAR(50) NULL DEFAULT NULL COMMENT 'Número de factura generada',
  PRIMARY KEY (`id`),
  INDEX `fk_ventas_perfil_cliente_idx` (`perfil_cliente_id` ASC) VISIBLE,
  CONSTRAINT `fk_ventas_perfil_cliente`
    FOREIGN KEY (`perfil_cliente_id`)
    REFERENCES `weber`.`perfiles_usuario` (`id`)
    ON DELETE RESTRICT
    ON UPDATE CASCADE,
  CONSTRAINT `fk_ventas_transacciones`
    FOREIGN KEY (`id`)
    REFERENCES `weber`.`transacciones` (`id`)
    ON DELETE CASCADE
    ON UPDATE CASCADE)
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `weber`.`detalles_ventas`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `weber`.`detalles_ventas` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `venta_id` BIGINT UNSIGNED NOT NULL,
  `producto_id` BIGINT UNSIGNED NOT NULL,
  `cantidad` DECIMAL(10,2) NOT NULL COMMENT 'Permite decimales para productos fraccionables',
  `precio_unitario` DECIMAL(15,2) NOT NULL COMMENT 'Precio de venta por unidad',
  `subtotal` DECIMAL(15,2) NOT NULL,
  `monto_descuento` DECIMAL(15,2) NULL DEFAULT '0.00',
  `monto_impuesto` DECIMAL(15,2) NULL DEFAULT '0.00',
  `costo_unitario_promedio` DECIMAL(15,2) NOT NULL COMMENT 'Costo promedio ponderado al momento de la venta',
  `ganancia_unitaria` DECIMAL(15,2) NOT NULL COMMENT 'Ganancia por unidad (precio_unitario - costo_unitario_promedio)',
  `ganancia_total` DECIMAL(15,2) NOT NULL COMMENT 'Ganancia total del detalle',
  `porcentaje_ganancia_real` DECIMAL(5,2) NOT NULL COMMENT 'Porcentaje de ganancia real obtenido',
  PRIMARY KEY (`id`),
  INDEX `fk_detalles_ventas_ventas_idx` (`venta_id` ASC) VISIBLE,
  INDEX `fk_detalles_ventas_productos_idx` (`producto_id` ASC) VISIBLE,
  INDEX `ganancia_idx` (`ganancia_total` ASC) VISIBLE,
  INDEX `porcentaje_ganancia_idx` (`porcentaje_ganancia_real` ASC) VISIBLE,
  CONSTRAINT `fk_detalles_ventas_productos`
    FOREIGN KEY (`producto_id`)
    REFERENCES `weber`.`productos` (`id`)
    ON DELETE RESTRICT
    ON UPDATE CASCADE,
  CONSTRAINT `fk_detalles_ventas_ventas`
    FOREIGN KEY (`venta_id`)
    REFERENCES `weber`.`ventas` (`id`)
    ON DELETE CASCADE
    ON UPDATE CASCADE)
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `weber`.`devoluciones`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `weber`.`devoluciones` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `fecha` DATETIME NOT NULL,
  `observaciones` TEXT NOT NULL,
  `perfil_empleado_id` BIGINT UNSIGNED NULL,
  `monto` DECIMAL(15,2) NOT NULL,
  `detalle_venta_id` BIGINT UNSIGNED NULL DEFAULT NULL COMMENT 'Para devoluciones de ventas',
  `detalle_compra_id` BIGINT UNSIGNED NULL DEFAULT NULL COMMENT 'Para devoluciones de compras',
  `tipo_devolucion` ENUM('Venta', 'Compra') NOT NULL,
  `estado` ENUM('Pendiente', 'Procesada', 'Cancelada') NULL DEFAULT 'Pendiente',
  PRIMARY KEY (`id`),
  INDEX `fk_devoluciones_perfil_empleado_idx` (`perfil_empleado_id` ASC) VISIBLE,
  INDEX `fk_devoluciones_detalle_venta_idx` (`detalle_venta_id` ASC) VISIBLE,
  INDEX `fk_devoluciones_detalle_compra_idx` (`detalle_compra_id` ASC) VISIBLE,
  INDEX `tipo_devolucion_idx` (`tipo_devolucion` ASC) VISIBLE,
  CONSTRAINT `fk_devoluciones_detalle_compra`
    FOREIGN KEY (`detalle_compra_id`)
    REFERENCES `weber`.`detalles_compras` (`id`)
    ON DELETE RESTRICT
    ON UPDATE CASCADE,
  CONSTRAINT `fk_devoluciones_detalle_venta`
    FOREIGN KEY (`detalle_venta_id`)
    REFERENCES `weber`.`detalles_ventas` (`id`)
    ON DELETE RESTRICT
    ON UPDATE CASCADE,
  CONSTRAINT `fk_devoluciones_perfil_empleado`
    FOREIGN KEY (`perfil_empleado_id`)
    REFERENCES `weber`.`perfiles_usuario` (`id`)
    ON DELETE SET NULL
    ON UPDATE CASCADE)
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `weber`.`movimientos_inventario`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `weber`.`movimientos_inventario` (
  `id` BIGINT(19) UNSIGNED NOT NULL AUTO_INCREMENT,
  `producto_id` BIGINT(19) UNSIGNED NOT NULL,
  `tipo_movimiento` ENUM('Entrada', 'Salida', 'Ajuste') NOT NULL,
  `tipo_documento` ENUM('Compra', 'Venta', 'Devolucion', 'Ajuste_Inventario') NOT NULL,
  `documento_id` BIGINT(19) UNSIGNED NOT NULL COMMENT 'ID del documento origen (compra_id, venta_id, etc.)',
  `detalle_documento_id` BIGINT(19) UNSIGNED NULL DEFAULT NULL COMMENT 'ID del detalle específico',
  `cantidad` DECIMAL(10,2) NOT NULL COMMENT 'Cantidad del movimiento (+ para entradas, - para salidas)',
  `costo_unitario` DECIMAL(15,2) NOT NULL COMMENT 'Costo unitario del movimiento',
  `costo_total` DECIMAL(15,2) NOT NULL COMMENT 'Costo total del movimiento',
  `detalle_compra_origen_id` BIGINT(19) UNSIGNED NULL DEFAULT NULL COMMENT 'De qué compra sale este producto (para salidas)',
  `stock_anterior` DECIMAL(10,2) NOT NULL,
  `stock_nuevo` DECIMAL(10,2) NOT NULL,
  `observaciones` TEXT NULL DEFAULT NULL,
  `usuario_perfil_id` BIGINT(19) UNSIGNED NULL DEFAULT NULL COMMENT 'Usuario que realizó el movimiento',
  `fecha_movimiento` DATETIME NOT NULL,
  PRIMARY KEY (`id`),
  INDEX `fk_movimientos_producto_idx` (`producto_id` ASC) VISIBLE,
  INDEX `fk_movimientos_usuario_idx` (`usuario_perfil_id` ASC) VISIBLE,
  INDEX `fk_movimientos_detalle_compra_idx` (`detalle_compra_origen_id` ASC) VISIBLE,
  INDEX `tipo_movimiento_idx` (`tipo_movimiento` ASC) VISIBLE,
  INDEX `tipo_documento_idx` (`tipo_documento` ASC) VISIBLE,
  INDEX `fecha_movimiento_idx` (`fecha_movimiento` ASC) VISIBLE,
  INDEX `documento_idx` (`tipo_documento` ASC, `documento_id` ASC) VISIBLE,
  CONSTRAINT `fk_movimientos_detalle_compra`
    FOREIGN KEY (`detalle_compra_origen_id`)
    REFERENCES `weber`.`detalles_compras` (`id`)
    ON DELETE SET NULL
    ON UPDATE CASCADE,
  CONSTRAINT `fk_movimientos_producto`
    FOREIGN KEY (`producto_id`)
    REFERENCES `weber`.`productos` (`id`)
    ON DELETE RESTRICT
    ON UPDATE CASCADE,
  CONSTRAINT `fk_movimientos_usuario`
    FOREIGN KEY (`usuario_perfil_id`)
    REFERENCES `weber`.`perfiles_usuario` (`id`)
    ON DELETE SET NULL
    ON UPDATE CASCADE)
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `weber`.`producto_categoria`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `weber`.`producto_categoria` (
  `producto_id` BIGINT UNSIGNED NOT NULL,
  `categoria_id` BIGINT UNSIGNED NOT NULL,
  PRIMARY KEY (`producto_id`, `categoria_id`),
  INDEX `fk_producto_categoria_productos_idx` (`producto_id` ASC) VISIBLE,
  INDEX `fk_producto_categoria_categorias_idx` (`categoria_id` ASC) VISIBLE,
  CONSTRAINT `fk_producto_categoria_categorias`
    FOREIGN KEY (`categoria_id`)
    REFERENCES `weber`.`categorias` (`id`)
    ON DELETE CASCADE
    ON UPDATE CASCADE,
  CONSTRAINT `fk_producto_categoria_productos`
    FOREIGN KEY (`producto_id`)
    REFERENCES `weber`.`productos` (`id`)
    ON DELETE CASCADE
    ON UPDATE CASCADE)
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;

USE `weber` ;

-- -----------------------------------------------------
-- Placeholder table for view `weber`.`v_archivos_por_modelo`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `weber`.`v_archivos_por_modelo` (`id` INT, `model` INT, `model_id` INT, `uuid` INT, `nombre_original` INT, `ruta_archivo` INT, `tipo_archivo` INT, `etiquetas` INT, `estado` INT, `nombre_relacionado` INT);

-- -----------------------------------------------------
-- Placeholder table for view `weber`.`v_disponibilidad_fifo`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `weber`.`v_disponibilidad_fifo` (`producto_id` INT, `codigo` INT, `nombre_producto` INT, `stock_total` INT, `detalle_compra_id` INT, `compra_id` INT, `cantidad_disponible` INT, `costo_unitario` INT, `precio_venta_calculado` INT, `porcentaje_ganancia_aplicado` INT, `lote` INT, `fecha_vencimiento` INT, `fecha_entrada` INT, `dias_para_vencer` INT);

-- -----------------------------------------------------
-- Placeholder table for view `weber`.`v_rentabilidad_productos`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `weber`.`v_rentabilidad_productos` (`producto_id` INT, `codigo` INT, `nombre_producto` INT, `total_ventas` INT, `cantidad_total_vendida` INT, `ingresos_totales` INT, `costos_totales` INT, `ganancia_total` INT, `porcentaje_ganancia_promedio` INT, `porcentaje_ganancia_minimo` INT, `porcentaje_ganancia_maximo` INT);

-- -----------------------------------------------------
-- Placeholder table for view `weber`.`v_todas_transacciones`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `weber`.`v_todas_transacciones` (`id` INT, `numero` INT, `perfil_usuario_id` INT, `perfil_empleado_id` INT, `fecha` INT, `monto` INT, `estado` INT, `tipo_transaccion` INT, `perfil_usuario_relacionado_id` INT, `metodo_pago` INT, `fecha_entrega` INT, `numero_factura` INT);

-- -----------------------------------------------------
-- View `weber`.`v_archivos_por_modelo`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `weber`.`v_archivos_por_modelo`;
USE `weber`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `weber`.`v_archivos_por_modelo` AS select `a`.`id` AS `id`,`a`.`model` AS `model`,`a`.`model_id` AS `model_id`,`a`.`uuid` AS `uuid`,`a`.`nombre_original` AS `nombre_original`,`a`.`ruta_archivo` AS `ruta_archivo`,`a`.`tipo_archivo` AS `tipo_archivo`,`a`.`etiquetas` AS `etiquetas`,`a`.`estado` AS `estado`,(case when (`a`.`model` = 'productos') then `p`.`nombre` when (`a`.`model` = 'usuarios') then concat(`pu`.`documento`,' - ',`pu`.`rol_negocio`) else 'Otro' end) AS `nombre_relacionado` from ((`weber`.`archivos` `a` left join `weber`.`productos` `p` on(((`a`.`model` = 'productos') and (`a`.`model_id` = `p`.`id`)))) left join `weber`.`perfiles_usuario` `pu` on(((`a`.`model` = 'usuarios') and (`a`.`model_id` = `pu`.`id`)))) where (`a`.`estado` = 'activo');

-- -----------------------------------------------------
-- View `weber`.`v_disponibilidad_fifo`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `weber`.`v_disponibilidad_fifo`;
USE `weber`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `weber`.`v_disponibilidad_fifo` AS select `p`.`id` AS `producto_id`,`p`.`codigo` AS `codigo`,`p`.`nombre` AS `nombre_producto`,`p`.`stock` AS `stock_total`,`dc`.`id` AS `detalle_compra_id`,`dc`.`compra_id` AS `compra_id`,`dc`.`cantidad_disponible` AS `cantidad_disponible`,`dc`.`costo_unitario` AS `costo_unitario`,`dc`.`precio_venta_calculado` AS `precio_venta_calculado`,`dc`.`porcentaje_ganancia_aplicado` AS `porcentaje_ganancia_aplicado`,`dc`.`lote` AS `lote`,`dc`.`fecha_vencimiento` AS `fecha_vencimiento`,`t`.`fecha` AS `fecha_entrada`,(case when (`dc`.`fecha_vencimiento` is not null) then (to_days(`dc`.`fecha_vencimiento`) - to_days(curdate())) else NULL end) AS `dias_para_vencer` from (((`weber`.`productos` `p` join `weber`.`detalles_compras` `dc` on((`p`.`id` = `dc`.`producto_id`))) join `weber`.`compras` `c` on((`dc`.`compra_id` = `c`.`id`))) join `weber`.`transacciones` `t` on((`c`.`id` = `t`.`id`))) where ((`dc`.`cantidad_disponible` > 0) and (`dc`.`esta_agotado` = false) and (`p`.`estado` = 'Activo')) order by `p`.`id`,`t`.`fecha`;

-- -----------------------------------------------------
-- View `weber`.`v_rentabilidad_productos`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `weber`.`v_rentabilidad_productos`;
USE `weber`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `weber`.`v_rentabilidad_productos` AS select `p`.`id` AS `producto_id`,`p`.`codigo` AS `codigo`,`p`.`nombre` AS `nombre_producto`,count(`dv`.`id`) AS `total_ventas`,coalesce(sum(`dv`.`cantidad`),0) AS `cantidad_total_vendida`,coalesce(sum(`dv`.`subtotal`),0) AS `ingresos_totales`,coalesce(sum((`dv`.`cantidad` * `dv`.`costo_unitario_promedio`)),0) AS `costos_totales`,coalesce(sum(`dv`.`ganancia_total`),0) AS `ganancia_total`,coalesce(avg(`dv`.`porcentaje_ganancia_real`),0) AS `porcentaje_ganancia_promedio`,coalesce(min(`dv`.`porcentaje_ganancia_real`),0) AS `porcentaje_ganancia_minimo`,coalesce(max(`dv`.`porcentaje_ganancia_real`),0) AS `porcentaje_ganancia_maximo` from (`weber`.`productos` `p` left join `weber`.`detalles_ventas` `dv` on((`p`.`id` = `dv`.`producto_id`))) where (`p`.`estado` = 'Activo') group by `p`.`id`,`p`.`codigo`,`p`.`nombre`;

-- -----------------------------------------------------
-- View `weber`.`v_todas_transacciones`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `weber`.`v_todas_transacciones`;
USE `weber`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `weber`.`v_todas_transacciones` AS select `t`.`id` AS `id`,`t`.`numero` AS `numero`,`t`.`perfil_usuario_id` AS `perfil_usuario_id`,`t`.`perfil_empleado_id` AS `perfil_empleado_id`,`t`.`fecha` AS `fecha`,`t`.`monto` AS `monto`,`t`.`estado` AS `estado`,'Venta' AS `tipo_transaccion`,`v`.`perfil_cliente_id` AS `perfil_usuario_relacionado_id`,`v`.`metodo_pago` AS `metodo_pago`,NULL AS `fecha_entrega`,`v`.`numero_factura` AS `numero_factura` from (`weber`.`transacciones` `t` join `weber`.`ventas` `v` on((`t`.`id` = `v`.`id`))) union all select `t`.`id` AS `id`,`t`.`numero` AS `numero`,`t`.`perfil_usuario_id` AS `perfil_usuario_id`,`t`.`perfil_empleado_id` AS `perfil_empleado_id`,`t`.`fecha` AS `fecha`,`t`.`monto` AS `monto`,`t`.`estado` AS `estado`,'Compra' AS `tipo_transaccion`,`c`.`perfil_proveedor_id` AS `perfil_usuario_relacionado_id`,NULL AS `metodo_pago`,`c`.`fecha_entrega` AS `fecha_entrega`,`c`.`numero_factura_proveedor` AS `numero_factura` from (`weber`.`transacciones` `t` join `weber`.`compras` `c` on((`t`.`id` = `c`.`id`)));

SET SQL_MODE=@OLD_SQL_MODE;
SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS;
SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS;
